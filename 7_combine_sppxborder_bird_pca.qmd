---
title: "IUCN + spp crossing - PCA & MCA clean"
format: 
  html:
    embed-resources: true
execute:
  warning: false
  message: false
---

```{r}
library(tidyverse)
library(terra)
library(sf)
library(rnaturalearth)
library(here)
library(iucnredlist) ### remotes::install_github("IUCN-UK/iucnredlist")
library(taxize)
library(janitor)
library(ggfortify)
library(cowplot)
```

This document is a streamlined version of 6_combine_sppxborder_bird_traits.qmd

```{r}
# Functions 
source(here("common_fxns.R"))
```

```{r}
# Read in Lawler data
spp_mapfiles <- list.files(here_anx('/data_lawler_2020/species_projections'), 
                           full.names = TRUE, recursive = TRUE, pattern = '.tif')
spp_all_df <- data.frame(f = spp_mapfiles,
                         spp = basename(spp_mapfiles) %>%
                           str_remove('(_gf85|_in85|_mc85|_bias).+') %>%
                           str_replace_all('_', ' '),
                         tax = basename(dirname(spp_mapfiles)))
```

```{r}
# Read in AVONET dataset (reading in BirdLife tab, which should match with IUCN names)
avonet <- read_csv(here("data-laa", "AVONET-birdlife-tab-supplementary-dataset-1.csv")) %>% 
  clean_names()
```

```{r}
# Filter for just Lawler birds
birds_all_df <- spp_all_df %>% 
  filter(tax == "Birds")
```

```{r}
birds_all <- birds_all_df %>% 
  group_by(spp, tax) %>% 
  summarize(files = n())
```

## Gather maps and aggregate

Following the method in 2_combine_spp_scenarios.qmd: 
For all the Lawler birds species (301) gather all future scenario maps and aggregate, summing and dividing by 3 to make a "probability" map for future distributions, and crop to just the lower 48 US states (and a little Canada and Mexico).  Then crop the historical maps to the same extent. 

### Aggregate future projections

For each species in the sample, aggregate the three future scenarios into a single map.  Crop to the lower continental US states.

```{r}
### set up extent for continental US
us_extent <- ext(c(xmin = -130, xmax = -65, ymin = 23, ymax = 50))

### Aggregate over the vector of species names
spp_vec <- birds_all_df$spp %>% unique()

future_rast <- lapply(spp_vec, FUN = agg_scenario, df = birds_all_df) %>%
  setNames(spp_vec) %>%
  rast()

x <- future_rast[[1]]
#plot(x, main = names(future_rast)[1])
```

### crop historical maps

```{r}
hist_rast <- lapply(spp_vec, FUN = agg_scenario, df = birds_all_df, 
                    scenario = 'historical') %>%
  setNames(spp_vec) %>%
  rast()

x <- hist_rast[[1]]
#plot(x, main = names(hist_rast)[1])

```

## Generate jurisdiction map

Let's generate a simple jurisdiction map - US states, and Canada and Mexico.

```{r}
states_sf <- ne_states(returnclass = 'sf', country = c('Mexico', 'Canada', 'United States of America')) 

state_id_df <- states_sf %>%
  st_drop_geometry() %>%
  mutate(juris = ifelse(adm0_a3 == 'USA', name, admin)) %>%
  select(id = gn_id, juris)
### plot(states_sf %>% select(iso_a2))
states_rast <- rasterize(states_sf, hist_rast, field = 'gn_id')
#plot(states_rast)
```

## Rough pass at classification?

For each spp let's create a dataframe of jurisdictions and cell values...

```{r}
state_spp_list <- lapply(spp_vec, FUN = extract_jurisdictions,
                         future_r = future_rast, 
                         hist_r = hist_rast,
                         juris_r = states_rast) %>%
  setNames(spp_vec) %>%
  bind_rows(.id = 'spp') %>%
  left_join(state_id_df, by = 'id') %>%
  ### note, Canada and Mexico have multiple jurisdictions (provinces and states)
  ### so sum up all those instances
  group_by(spp, juris) %>%
  summarize(n_historical = sum(n_historical),
            n_future = sum(n_future), 
            .groups = 'drop')
```

## Interpret results

Interpret historical and future cell counts into entry/exit/no presence/continued presence.  NOTE: probably would want to throw a threshold on the cell counts, like at least 10 cells to actually register...

Let's filter to the birds that easly merge with the Avonet dataset (270)

```{r}
# See how well the Avonet trait data merges in 
# 270 of 301 have matches - could work with these species for now since they should be able to match wiht IUCN
birds_avonet <- left_join(birds_all, (avonet %>% rename(spp = species1)))

lawler_avvonet_birds <- birds_avonet %>% 
  drop_na(sequence)

lawler_avvonet_birds_vec <- lawler_avvonet_birds$spp
```

```{r}
all_juris_df <- state_spp_list %>%
  filter(spp %in% lawler_avvonet_birds_vec) %>% 
  group_by(spp) %>% 
  mutate(range_historical = sum(n_historical),
         range_future = sum(n_future),
         range_ratio = range_future/range_historical,
         prec_historical = 100*n_historical/sum(n_historical),
         prec_future = 100*n_future/sum(n_future),
         prec_pt_change = prec_future - prec_historical) %>% 
  mutate(status = case_when(n_historical == 0 &  n_future > 0 ~ 'entry into new',
                            n_historical > 0  & n_future == 0 ~ 'exit from historical',
                            n_historical == 0 & n_future == 0 ~ 'no presence',
                            TRUE ~ 'continued presence')) %>% 
  ungroup()

all_juris_df$status %>% table()
```

```{r}
entry_exit <- all_juris_df %>% 
  filter(status %in% c("entry into new", "exit from historical")) #%>% 
  #separate(spp, into = c("genus", "species"), sep = " ", remove = FALSE) %>% 
  #rename(scientific_name = spp)
```

```{r}
# Just focusing on country level jurisdiction movement for now
entry_exit_ca_mx <- entry_exit %>% 
  mutate(country = case_when(juris == "Canada" ~ "Canada",
                             juris == "Mexico" ~ "Mexico",
                             TRUE ~ "United States")) %>% 
  filter(country != "United States")
```

# Test out Canada birds that don't migrate and assign binary variable for diet type

```{r}
birds_all_juris_avonet <- left_join(all_juris_df, (avonet %>% rename(spp = species1)))
```

```{r}
# Canada data
ca_data <- birds_all_juris_avonet %>% 
  filter(juris == "Canada") %>% 
  filter(status != "no presence")
```

```{r}
ca_sed <- ca_data %>% 
  # Migration == 1 is sedentary lifestyle
  filter(migration == 1) %>% 
  mutate(trophic_level = tolower(trophic_level)) %>% 
  mutate(trophic_level_value =1) %>% 
  # binary variable for trophic level (carnivore, herbivore, omnivore, scavenger)
  pivot_wider(names_from = trophic_level,
              values_from = trophic_level_value,
              values_fill = 0)
  
```

```{r}
# Canada sedentary - (historical vs. future)
ca_sed_hist <- ca_sed %>% 
  filter(status != "entry into new") %>% 
  mutate(hist_or_future = "historical")

ca_sed_future <- ca_sed%>% 
  filter(status != "exit from historical") %>% 
  mutate(hist_or_future = "future")

ca_sed_hist_future <- rbind(ca_sed_hist, ca_sed_future)
```


```{r}
# Prep for PCA
ca_pca_sed_logged <- ca_sed_hist_future %>% 
  select(c(spp, hist_or_future, beak_length_culmen, tarsus_length, wing_length, hand_wing_index, tail_length, mass, carnivore, herbivore, omnivore, scavenger)) %>% 
  # log transform in preparation for PCA
  mutate(across(c(beak_length_culmen:mass), log))
  
```

```{r}
# centered at zero (center = TRUE) and z-transformed (scale = TRUE)
pca_ca_sed<- prcomp(ca_pca_sed_logged[3:12], center = TRUE, scale = TRUE )
```

```{r}
summary(pca_ca_sed)
```

```{r}
autoplot(pca_ca_sed,
         data = ca_pca_sed_logged,
         color = "hist_or_future",
         loadings = TRUE,
         loadings.label = TRUE)
```

```{r}
# Convert results into data frame
ca_sed_pca_df <- as.data.frame(pca_ca_sed$x) %>% 
  mutate(spp = ca_pca_sed_logged$spp,
         hist_or_future = ca_pca_sed_logged$hist_or_future)
```

```{r}
ca_sed_pca_hull <- ca_sed_pca_df %>%
  arrange(hist_or_future, PC1, PC2) %>% 
  group_by(hist_or_future) %>% 
  slice(chull(PC1, PC2))

ca_sed_pca_hull_32 <- ca_sed_pca_df %>%
  arrange(hist_or_future, PC3, PC2) %>% 
  group_by(hist_or_future) %>% 
  slice(chull(PC3, PC2))
```

```{r}
# Scale factor for loadings
ca_sed_scale <- min(max(abs(ca_sed_pca_df$PC1)), max(abs(ca_sed_pca_df$PC2))) / 
  max(abs(pca_ca_sed$rotation[, 1:2]))

# Get rotation dataframe for loadings (arrows)
ca_sed_rot_df <- data.frame(pca_ca_sed$rotation %>% round(4) *
                                 ca_sed_scale) %>% 
  mutate(query = rownames(.))
```


```{r}
ggplot(ca_sed_pca_df, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = hist_or_future,
                 fill = hist_or_future,
                 stroke = 1), alpha = 0.5) +
  geom_segment(data = ca_sed_rot_df, x = 0, y = 0,
               aes(xend = PC1, yend = PC2),
               arrow = arrow(length = unit(.1, 'inches'))) +
  geom_text(data = ca_sed_rot_df, aes(label = query))+
  geom_polygon(data = ca_sed_pca_hull,
               aes(x = PC1, y = PC2,
                   color = hist_or_future, fill = hist_or_future), alpha = 0.2) +
  labs(title = "Canada non-migratory - historical and future PCA")
```

```{r}
ca_sed_gns_spp <- ca_sed_pca_df %>% 
  separate(spp, into = c("genus", "species"), sep = " ", remove = FALSE) %>% 
  rename(scientific_name = spp) %>% 
  group_by(scientific_name, genus, species) %>% 
  summarise(count = n()) %>% 
  ungroup()
```

# Add in IUCN info

```{r}
api_key <- Sys.getenv("IUCN_API_KEY") ### usethis::edit_r_environ() to add key to R environment file
api <- init_api(api_key)
```

```{r}
# Pull the genus and species names
ca_sed_gns <- ca_sed_gns_spp$genus
ca_sed_species <- ca_sed_gns_spp$species
```

```{r}
# Amazilia beryllina [2] should be Saucerottia beryllina
# Amazilia violiceps [3] should be Leucolia violiceps
# Falcipennis canadensis [36] should be Canachites canadensis
ca_sed_gns[2] <- "Saucerottia"
ca_sed_gns[3] <- "Leucolia"
ca_sed_gns[36] <- "Canachites"
```

```{r}
# Loop through function, save as list
ca_sed_iucn_id_list <- list()
for(i in 1:length(ca_sed_species)){
  test <- iucn_id(api, ca_sed_gns[i], ca_sed_species[i])
  ca_sed_iucn_id_list[[i]] <- test
}
```

```{r}
ca_sed_id_vector <- unlist(ca_sed_iucn_id_list)
```

```{r}
# Run the assessment numbers collected from the iucn_id function
# 54 unique assessment IDs (have species repeaeted in historic and future)
ca_sed_id_data <- assessment_data_many(api, ca_sed_id_vector, wait_time = 0.5)
```

```{r}
# Extract the IUCN status from all the sample species (or any other variable of interest)
# Run element_names() to see what you can extract
ca_sed_names <- extract_element(ca_sed_id_data, "taxon")
ca_sed_status <- extract_element(ca_sed_id_data, "red_list_category")
ca_sed_trends <- extract_element(ca_sed_id_data, "population_trend")

ca_sed_names_status <- left_join(ca_sed_names, ca_sed_status, by = "assessment_id")
ca_sed_names_status_trends <- left_join(ca_sed_names_status, ca_sed_trends,
                                           by = "assessment_id") %>% 
  mutate(threatened = case_when(description.x %in% c("Least Concern", "Near Threatened") ~ "not threatened",
                               TRUE ~ "threatened"))
```

```{r}
ca_sed_iucn_clean <- ca_sed_names_status_trends %>% 
  dplyr::select(scientific_name, description.x, description.y, threatened) %>% 
  rename(spp = scientific_name, 
         iucn_status = description.x,
         iucn_trend = description.y) %>% 
  # return scientific names to Lawler dataset
  mutate(spp = case_when(spp == "Saucerottia beryllina" ~ "Amazilia beryllina",
                         spp == "Leucolia violiceps" ~"Amazilia violiceps",
                         spp == "Canachites canadensis" ~ "Falcipennis canadensis",
                         TRUE ~ spp))
```

```{r}
ca_sed_iucn_count <- left_join(ca_sed_hist_future, ca_sed_iucn_clean) %>% 
  group_by(hist_or_future, threatened) %>% 
  summarize(n_carnivore = sum(carnivore),
            n_herbivore = sum(herbivore),
            n_omnivore = sum(omnivore),
            n_scavenger = sum(scavenger),
            n_total = n()) %>% 
  ungroup()
```

```{r}
ca_sed_pca_df_iucn <- left_join(ca_sed_pca_df, ca_sed_iucn_clean)
```

```{r}
sed_p12 <- ggplot(ca_sed_pca_df_iucn, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = hist_or_future,
                 shape = threatened), size = 2.5, alpha = 0.5) +
  geom_segment(data = ca_sed_rot_df, x = 0, y = 0,
               aes(xend = PC1, yend = PC2),
               arrow = arrow(length = unit(.1, 'inches'))) +
  geom_text(data = ca_sed_rot_df, aes(label = query))+
  geom_polygon(data = ca_sed_pca_hull,
               aes(x = PC1, y = PC2,
                   color = hist_or_future, fill = hist_or_future), alpha = 0.2) +
  labs(title = "Canada non-migratory")
```

```{r}
sed_p32 <- ggplot(ca_sed_pca_df_iucn, aes(x = PC3, y = PC2)) +
  geom_point(aes(color = hist_or_future,
                 shape = threatened), size = 2.5, alpha = 0.5) +
  geom_segment(data = ca_sed_rot_df, x = 0, y = 0,
               aes(xend = PC3, yend = PC2),
               arrow = arrow(length = unit(.1, 'inches'))) +
  geom_text(data = ca_sed_rot_df, aes(label = query))+
  geom_polygon(data = ca_sed_pca_hull_32,
               aes(x = PC3, y = PC2,
                   color = hist_or_future, fill = hist_or_future), alpha = 0.2) +
  labs(title = "")
```

```{r}
plot_grid(sed_p12 + theme(legend.position = 'none'), sed_p32 + theme(axis.title.y = element_blank()), rel_widths = c(2, 3.6))
```

# Test out using categorical variables in MCA

```{r}
library(MASS)
```

```{r}
# Filter the Canada sedentary birds so that it is just the categorical variables 
```

```{r}
# Canada data
ca_data <- birds_all_juris_avonet %>% 
  filter(juris == "Canada") %>% 
  filter(status != "no presence")
```

```{r}
ca_sed_cat <- ca_data %>% 
  # Migration == 1 is sedentary lifestyle
  filter(migration == 1) %>% 
  # categorical variables include habitat, tropic niche, and lifestyle
  dplyr::select(spp, habitat, trophic_niche, primary_lifestyle)

# Add whether spp are historic or future
ca_sed_cat_hist_fut <- left_join(ca_sed_cat, 
                                 (ca_sed_hist_future %>% 
                                    dplyr::select(spp, hist_or_future)))
```

```{r}
# Create dataframe of factors (required for MASS:mca)
ca_sed_mca_prep <- ca_sed_cat_hist_fut[2:4] %>% 
  lapply(., as.factor) %>% 
  as.data.frame()
```

```{r}
# Number of categories per variable
cats = apply(ca_sed_mca_prep, 2, function(x) nlevels(as.factor(x)))
cats
```

```{r}
# MCA
ca_sed_mca <- mca(ca_sed_mca_prep)
```

```{r}
# Test out plotting
# Variable coordinates (adjectives are the columns (cs))
ca_sed_mca_var_df <- data.frame(ca_sed_mca$cs, Variable = rep(names(cats), cats),
                                Variable_value = (rownames(ca_sed_mca$cs))) %>% 
  mutate(Variable_value = sub('.*\\.', '', Variable_value))

# Observation coordinates (individual observations are the rows (rs))
ca_sed_mca_obs_df <- data.frame(ca_sed_mca$rs) %>% 
  mutate(hist_or_future = ca_sed_hist_future$hist_or_future)

# MCA plot
ggplot(data = ca_sed_mca_var_df, aes(x = X1, y = X2, label = Variable_value)) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_vline(xintercept = 0, color = "gray") +
  geom_text(aes(color = Variable)) +
  ggtitle("MCA plot of non-migratory Canada birds") +
  scale_x_continuous(limits = c(-0.20, 0.05)) +
  theme_bw() +
  theme(legend.position = "bottom")
```

```{r}
ca_sed_mca_hull <- ca_sed_mca_obs_df %>%
  arrange(hist_or_future, X1, X2) %>% 
  group_by(hist_or_future) %>% 
  slice(chull(X1, X2))

```

```{r}
ggplot(data = ca_sed_mca_obs_df, aes(x = X1, y = X2)) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_vline(xintercept = 0, color = "gray") +
  geom_point(aes(color = hist_or_future), alpha = 0.2, size = 2.5) +
  geom_polygon(data = ca_sed_mca_hull,
               aes(x = X1, y = X2,
                   color = hist_or_future), alpha = 0) +
  geom_text(data = ca_sed_mca_var_df,
            aes(x = X1, y = X2, 
                label = Variable_value, color = Variable)) +
  scale_x_continuous(limits = c(-0.20, 0.05)) +
  labs(title = "MCA plot of non-migratory Canada birds",
       fill = "",
       color = "") +
  theme_bw() +
   theme(legend.position = "bottom")
```


