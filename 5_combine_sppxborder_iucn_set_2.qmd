---
title: "IUCN + spp crossing borders - set 2"
format: 
  html:
    embed-resources: true
execute:
  warning: false
  message: false
---

```{r}
library(tidyverse)
library(terra)
library(sf)
library(rnaturalearth)
library(here)
library(iucnredlist) ### remotes::install_github("IUCN-UK/iucnredlist")
library(taxize)
```

## Gather maps and aggregate

Following the method in 2_combine_spp_scenarios.qmd: 
Grab a sample of species (10 spp for each taxon), gather all future scenario maps and aggregate, summing and dividing by 3 to make a "probability" map for future distributions, and crop to just the lower 48 US states (and a little Canada and Mexico).  Then crop the historical maps to the same extent.  

### Identify species sample

```{r}
here_anx <- function(f = '', ...) { 
  ### create file path to git-annex dir for project
  f <- paste(f, ..., sep = '/')
  f <- stringr::str_replace_all(f, '\\/+', '/')
  f_anx <- sprintf('/home/shares/usgs-cap-rangeshifts/data_lawler_2020/%s', f)
  return(f_anx)
}
```

List all map files available, and gather info on species, taxon, and scenario from the file path information.

```{r}
spp_mapfiles <- list.files(here_anx('species_projections'), 
                           full.names = TRUE, recursive = TRUE, pattern = '.tif')
spp_all_df <- data.frame(f = spp_mapfiles,
                         spp = basename(spp_mapfiles) %>%
                           str_remove('(_gf85|_in85|_mc85|_bias).+') %>%
                           str_replace_all('_', ' '),
                         tax = basename(dirname(spp_mapfiles)))

### sample 10 species per taxon, and identify all scenario maps for each
set.seed(16)
spp_sample_df <- spp_all_df %>%
  select(-f) %>%
  distinct() %>%
  group_by(tax) %>%
  slice_sample(n = 10) %>%
  ungroup() %>%
  left_join(spp_all_df)
```

### Aggregate future projections

For each species in the sample, aggregate the three future scenarios into a single map.  Crop to the lower continental US states.

```{r}
### set up extent for continental US
us_extent <- ext(c(xmin = -130, xmax = -65, ymin = 23, ymax = 50))

### Define aggregation function
agg_scenario <- function(s, df, scenario = 'future') {
  ### for species s, filter historical map files from df; rasterize; mean
  
  if(scenario == 'future') { ### filter to non-Historical
    s_df <- df %>%
      filter(spp == s & !str_detect(f, 'Historical'))
  } else { ### else filter to Historical
    s_df <- df %>%
      filter(spp == s & str_detect(f, 'Historical'))
  }
  s_map <- rast(s_df$f) %>%
    crop(us_extent) %>%
    sum(na.rm = TRUE)
  s_map <- s_map / nrow(s_df)
  return(s_map)
}

### Aggregate over the vector of species names
spp_vec <- spp_sample_df$spp %>% unique()

future_rast <- lapply(spp_vec, FUN = agg_scenario, df = spp_sample_df) %>%
  setNames(spp_vec) %>%
  rast()

x <- future_rast[[1]]
#plot(x, main = names(future_rast)[1])
```

### crop historical maps

```{r}
hist_rast <- lapply(spp_vec, FUN = agg_scenario, df = spp_sample_df, 
                    scenario = 'historical') %>%
  setNames(spp_vec) %>%
  rast()

x <- hist_rast[[1]]
#plot(x, main = names(hist_rast)[1])

```

## Generate jurisdiction map

Let's generate a simple jurisdiction map - US states, and Canada and Mexico.

```{r}
states_sf <- ne_states(returnclass = 'sf', country = c('Mexico', 'Canada', 'United States of America')) 

state_id_df <- states_sf %>%
  st_drop_geometry() %>%
  mutate(juris = ifelse(adm0_a3 == 'USA', name, admin)) %>%
  select(id = gn_id, juris)
### plot(states_sf %>% select(iso_a2))
states_rast <- rasterize(states_sf, hist_rast, field = 'gn_id')
#plot(states_rast)
```

## Rough pass at classification?

For each spp let's create a dataframe of jurisdictions and cell values...

```{r}
extract_jurisdictions <- function(spp, future_r, hist_r, juris_r) {
  ### spp <- spp_vec[1]
  ### future_r = future_rast; hist_r = hist_rast; juris_r = states_rast
  s_f_r <- future_r[[names(future_r) == spp]]
  s_h_r <- hist_r[[names(hist_r) == spp]]
  s_df <- data.frame(values(s_h_r), 
                     values(s_f_r), 
                     values(juris_r)) %>%
    setNames(c('historical', 'future', 'id')) %>%
    filter(!is.na(id)) %>%
    filter(!is.na(historical) | !is.na(future)) %>%
    group_by(id) %>%
    summarize(n_historical = sum(historical > .25),
              n_future = sum(future > .5))
  
  return(s_df)
}

state_spp_list <- lapply(spp_vec, FUN = extract_jurisdictions,
                         future_r = future_rast, 
                         hist_r = hist_rast,
                         juris_r = states_rast) %>%
  setNames(spp_vec) %>%
  bind_rows(.id = 'spp') %>%
  left_join(state_id_df, by = 'id') %>%
  ### note, Canada and Mexico have multiple jurisdictions (provinces and states)
  ### so sum up all those instances
  group_by(spp, juris) %>%
  summarize(n_historical = sum(n_historical),
            n_future = sum(n_future), 
            .groups = 'drop')
```

## Interpret results

Interpret historical and future cell counts into entry/exit/no presence/continued presence.  NOTE: probably would want to throw a threshold on the cell counts, like at least 10 cells to actually register...

```{r}
all_juris_df <- state_spp_list %>%
  group_by(spp) %>% 
  mutate(range_historical = sum(n_historical),
         range_future = sum(n_future),
         range_ratio = range_future/range_historical,
         prec_historical = 100*n_historical/sum(n_historical),
         prec_future = 100*n_future/sum(n_future),
         prec_pt_change = prec_future - prec_historical) %>% 
  mutate(status = case_when(n_historical == 0 &  n_future > 0 ~ 'entry into new',
                            n_historical > 0  & n_future == 0 ~ 'exit from historical',
                            n_historical == 0 & n_future == 0 ~ 'no presence',
                            TRUE ~ 'continued presence')) %>% 
  ungroup()

all_juris_df$status %>% table()
```

```{r}
entry_exit <- all_juris_df %>% 
  filter(status %in% c("entry into new", "exit from historical")) #%>% 
  #separate(spp, into = c("genus", "species"), sep = " ", remove = FALSE) %>% 
  #rename(scientific_name = spp)
```

```{r}
# Run species names through taxize
# temp is spp_vec[1:30]
temp <- gna_verifier(spp_vec[1:30]) %>% 
  separate(currentCanonicalSimple, into = c("current_genus", "current_species"), sep = " ", remove = FALSE)

temp_2 <- gna_verifier(spp_vec[31:60]) %>% 
  separate(currentCanonicalSimple, into = c("current_genus", "current_species"), sep = " ", remove = FALSE)
```

```{r}
# Pull the genus and species names
gns_vec_current <- temp$current_genus
species_vec_current <- temp$current_species
gns_vec_current_2 <- temp_2$current_genus
species_vec_current_2 <- temp_2$current_species
```

## Add IUCN information

For those species that enter into a new area or exit an area, add IUCN information.
Based on code in 3_explore_spp_threat_status.qmd

```{r}
api_key <- Sys.getenv("IUCN_API_KEY") ### usethis::edit_r_environ() to add key to R environment file
api <- init_api(api_key)
```

```{r}
# Write a function to get the most recent, global iucn assessment id for each species
iucn_id <- function(api, genus, species){
  # get species info 
 species_info <- assessments_by_name(api, genus, species) 
 list_status <- species_info %>% 
   filter(scopes_code == 1 & latest == TRUE) #%>% 
   #filter(year_published == max(year_published))
 return(list_status$assessment_id)
}
```

```{r}
# taxize didn't catch the misspelling for Ptilogonys cinereus (Ptiliogonys)
gns_vec_current[12] <- "Ptiliogonys"
# taxize not catching the genus change from Tamias to Neotamias for all chipmunks except the Eastern Chipmunk and Siberian Chipmunk
gns_vec_current[22] <- "Neotamias"
gns_vec_current[26] <- "Neotamias"

# Helictotrichon was orignial genus name and correct name for IUCN
gns_vec_current_2[7] <- "Helictotrichon"
```


```{r}
# Loop through function, save as list
iucn_id_list <- list()
for(i in 1:length(species_vec_current)){
  test <- iucn_id(api, gns_vec_current[i], species_vec_current[i])
  iucn_id_list[[i]] <- test
}

iucn_id_list_2 <- list()
for(i in 1:length(species_vec_current_2)){
  test <- iucn_id(api, gns_vec_current_2[i], species_vec_current_2[i])
  iucn_id_list_2[[i]] <- test
}
```

```{r}
id_vector <- unlist(iucn_id_list)
id_vector_2 <- unlist(iucn_id_list_2)
```

```{r}
id_vector_3 <- c(id_vector, id_vector_2)
```


```{r}
# Run the assessment numbers collected from the iucn_id function
id_data <- assessment_data_many(api, id_vector_3, wait_time = 0.5)
```

```{r}
# Extract the IUCN status from all the sample species (or any other variable of interest)
# Run element_names() to see what you can extract
id_names <- extract_element(id_data, "taxon")
# taxon_synonyms might be able to help with some of the scientific name issues
id_synonyms <- extract_element(id_data, "taxon_synonyms")
id_iucn_status <- extract_element(id_data, "red_list_category")
id_pop_trends <- extract_element(id_data, "population_trend")

id_names_status <- left_join(id_names, id_iucn_status, by = "assessment_id")
id_names_status_trends <- left_join(id_names_status, id_pop_trends, by = "assessment_id")
```

```{r}
# Merge in entry / exit information 
# Get the crosswalk of lawler names and taxize names
spp_taxize_xwlk <- rbind(temp, temp_2) %>% 
  select(submittedName, currentCanonicalSimple) %>% 
  # Correct the current_genus, current_species names for which taxize didn't work
  mutate(scientific_name = case_when(currentCanonicalSimple == "Ptilogonys cinereus" ~ "Ptiliogonys cinereus",
                                     currentCanonicalSimple == "Tamias sonomae" ~ "Neotamias sonomae",
                                     currentCanonicalSimple == "Tamias obscurus" ~ "Neotamias obscurus",
                                     currentCanonicalSimple == "Graphephorum canescens" ~ submittedName,
                                     TRUE ~ currentCanonicalSimple)) %>% 
  separate(scientific_name, into = c("genus", "species"), sep = " ", remove = FALSE)

id_names_status_trends_submittednme <- left_join(id_names_status_trends, spp_taxize_xwlk, by = "scientific_name")

entry_exit_clean <- entry_exit %>% 
  rename(submittedName = spp)

entry_exit_iucn <- inner_join(entry_exit_clean, id_names_status_trends_submittednme, by = "submittedName")
```

# What about seeing which species are only native to the three countries?

```{r}
id_loc <- extract_element(id_data, "locations")
```

```{r}
# Add a column for country to merge in country level location information
# There is some US-state level infomration, but country level should capture what we need for now
entry_exit_iucn <- entry_exit_iucn %>% 
  mutate(country = case_when(juris == "Canada" ~ "Canada",
                             juris == "Mexico" ~ "Mexico",
                             TRUE ~ "United States"))
```

```{r}
entry_exit_iucn_loc <- left_join(entry_exit_iucn, (id_loc %>% 
                                                      rename(country = description)),
                                  by = join_by(country, assessment_id))

# There's a few examples here where the species is moving into Canada, so there is no IUCN location information about the species in Canada
```

# Which of the species in the entry/exit df are endemic species? (would be for CA/US/MX)

```{r}
endemic_species <- entry_exit_iucn_loc %>% 
  filter(is_endemic == TRUE) 

endemic_species_vec <- unique(endemic_species$scientific_name)
```

```{r}
# Filter entry_exit_iucn_loc for the endemic species (want to get all the entries)
entry_exit_endemic_spp <- entry_exit_iucn_loc %>% 
  filter(scientific_name %in% endemic_species_vec)
```

```{r}
# Stats - table is helpful to view which endemic species are moving between jurisdictions 
entry_exit_endemic_summary <- entry_exit_endemic_spp %>% 
  group_by(scientific_name, status, index.y, description.x, index.x.x, description.y,
           country, is_endemic, origin) %>% 
  summarize(n_juris = n(),
            n_historical = sum(n_historical),
            n_future = sum(n_future)) %>% 
  ungroup()
```

```{r}
# Filter further for those entering/exiting CA and MX
# 11 species moving in or out of mexico
entry_exit_CA_MX_summary <- entry_exit_endemic_spp %>% 
  filter(country != "United States")

# These species are endemic to the US
CA_MX_summary <- entry_exit_CA_MX_summary %>% 
  group_by(description.x, juris, status, description.y) %>% 
  summarize(n_species = n()) %>% 
  rename(red_list_cat = description.x,
         population_trend = description.y)
```

```{r}
print(CA_MX_summary)
```

## Maps for a few of the species moving into/out of MX or CA

Near threatened Kirtland's snake (Clonophis kirtlandii) moving within US (not a lot of non-least concern in this batch)
Interesting in that its presence in Canada goes from 88 to 2187 cells which is flagged as continued presence.
```{r}
plot(hist_rast$`Clonophis kirtlandii`, main = "Clonophis kirtlandii - historical")
plot(future_rast$`Clonophis kirtlandii`, main = "Clonophis kirtlandii - future")
```
```{r}
ck <- all_juris_df %>% 
  filter(spp == "Clonophis kirtlandii")
sum(ck$n_historical)
sum(ck$n_future)

ck_summary <- ck %>% 
  mutate(prop_historical = n_historical/sum(n_historical),
         prop_future = n_future/sum(n_future),
         ratio = prop_future/prop_historical)
```

## Look at range changes for Canada and Mexico

```{r}
canada_df <- all_juris_df %>% 
  filter(juris == "Canada")
```

```{r}
canada_df %>% 
  filter(status != "no presence") %>% 
  mutate(spp_name = fct_reorder(spp, prec_pt_change)) %>% 
  ggplot() +
  geom_bar(aes(x = spp_name, y = prec_pt_change, fill = status), stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Canada",
       x = "",
       y = "% point change from historic to future range")
```
Clonophis kirtlandii (Kirtland’s snake) goes from having 1% of its range (88/7909) in Canada to 44% (2187/4926) of its range in Canada (furthermore, Kirkland’s snake is generally not accepted to be in Canada yet). It's labeled as 'continued presence.'

```{r}
mexico_df <- all_juris_df %>% 
  filter(juris == "Mexico")
```

```{r}
mexico_df %>% 
  filter(status != "no presence") %>% 
  mutate(spp_name = fct_reorder(spp, prec_pt_change)) %>% 
  ggplot() +
  geom_bar(aes(x = spp_name, y = prec_pt_change, fill = status), stat = "identity") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Mexico",
       x = "",
       y = "% point change from historic to future range")
```

